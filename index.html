<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Padre IANN | Confesionario Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }
    
     html, body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #311840;
      color: #fff;
      height: 100vh;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    #bannerPrivacidad {
      position: fixed;
      inset: 0;
      background: rgba(18, 27, 34, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #popup {
      background: #1e2a35;
      padding: 30px;
      border-radius: 10px;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 0 20px #0f0;
      color: #d1d1d1;
    }

    #popup h2 {
      margin-top: 0;
      color: #25d366;
    }

    #popup p {
      font-size: 16px;
      margin-bottom: 20px;
      line-height: 1.4;
    }

    #popup button {
      padding: 12px 25px;
      font-size: 16px;
      background: #25d366;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      color: #111;
      font-weight: 600;
      transition: background 0.3s;
    }
    #popup button:hover {
      background: #1ebe57;
    }

    #confesionario {
      max-width: %95;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      padding: 0;
    }

   #confesionario .logo {
  width: 100%;
  height: 60px;
  background: #075e54;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgb(0 0 0 / 0.2);
}

#confesionario .logo img {
  height: 40px;
  max-width: 90%;
  object-fit: contain;
  user-select: none;
}

    #chatArea {
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  height: 100%;  /* o flex: 1 si us√°s flexbox */
  scroll-behavior: smooth; /* tambi√©n para el scroll nativo */
  padding-bottom: 120px; /* Ajust√° este valor seg√∫n la altura de #inputArea */
}

   
    .mensaje {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 20px;
      line-height: 1.3;
      word-wrap: break-word;
      font-size: 1rem;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
      user-select: text;
      animation: fadeInUp 0.3s ease forwards;
    }

    .mensaje.usuario {
      align-self: flex-end;
      background-color: #dcf8c6;
      color: #111;
      border-bottom-right-radius: 5px;
      border-bottom-left-radius: 20px;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
    }

    .mensaje.padre {
      align-self: flex-start;
      background-color: #2a3942;
      color: #e1e1e1;
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 20px;
      border-top-right-radius: 20px;
      border-top-left-radius: 20px;
    }

    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    #inputArea {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 600px;
      background: #202c33;
      padding: 10px 15px;
      display: flex;
      gap: 8px;
      align-items: center;
      box-shadow: 0 -1px 5px rgb(0 0 0 / 0.3);
      z-index: 20;
    }

    textarea#confesion {
      flex: 1;
      min-height: 40px;
      max-height: 120px;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 20px;
      border: none;
      resize: none;
      background: #323c42;
      color: white;
      font-family: inherit;
      outline: none;
      box-shadow: inset 0 1px 1px rgb(0 0 0 / 0.2);
      transition: background 0.3s;
    }
    textarea#confesion::placeholder {
      color: #bbb;
    }
    textarea#confesion:focus {
      background: #4a5a63;
    }

    button.enviar {
      background: #25d366;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
      user-select: none;
      box-shadow: 0 2px 5px rgb(0 0 0 / 0.3);
    }

    button.enviar:hover { background: #1ebe57; }
    button.enviar:active { background: #189e43; }
    button.enviar[disabled] {
      background: #9de4b3;
      cursor: not-allowed;
    }

    #btnDonar, #btnCompartir {
      position: fixed;
      bottom: 80px;
      width: 50px;
      height: 50px;
      font-size: 28px;
      border: none;
      border-radius: 50%;
      background: #202c33;
      color: #25d366;
      box-shadow: 0 0 8px #25d366;
      cursor: pointer;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: background 0.3s;
    }

    #btnDonar:hover, #btnCompartir:hover {
      background: #25d366;
      color: #111;
      box-shadow: 0 0 15px #25d366;
    }

    #btnDonar { left: 20px; }
    #btnCompartir { right: 20px; }

    #popupDonar {
      position: fixed;
      bottom: 140px;
      left: 20px;
      width: 280px;
      background: #1e2a35;
      color: #d1d1d1;
      padding: 15px;
      border-radius: 10px;
      display: none;
      z-index: 9999;
      box-shadow: 0 0 15px #25d366;
      font-size: 14px;
      line-height: 1.4;
    }

    #popupDonar a {
      display: inline-block;
      margin-top: 10px;
      background: #25d366;
      padding: 10px 15px;
      color: #111;
      text-decoration: none;
      border-radius: 5px;
      font-weight: 600;
      transition: background 0.3s;
    }

    #popupDonar a:hover {
      background: #1ebe57;
    }
  </style>
</head>
<body>

<div id="bannerPrivacidad">
  <div id="popup">
    <h2>Confesionario Digital</h2>
    <p>‚ÄúEste espacio no reemplaza tu fe. S√≥lo es una voz para acompa√±arte cuando el silencio pesa.‚Äù</p>
    <button onclick="cerrarPrivacidad()">Entiendo y acepto</button>
  </div>
</div>

<div id="confesionario" style="display:none;">
  <div class="logo">
  <img src="https://i.ibb.co/tM91jjxj/logo-capilla-digital.png" alt="Logo de Padre IANN" /></div>

  <div id="chatArea">
    <div id="respuesta" style="display:none;"></div>
  </div>

  <div id="inputArea">
    <textarea id="confesion" placeholder="Contame qu√© te pasa..." rows="1" oninput="autoExpand(this)"></textarea>
    <button class="enviar" title="Dictar confesi√≥n" onclick="iniciarEscucha()">üéôÔ∏è</button>
    <button class="enviar" title="Enviar confesi√≥n" onclick="enviarConfesion()">üôè</button>
  </div>
</div>

<button id="btnDonar" title="Ayud√° a sostener este espacio">üíö</button>
<div id="popupDonar">
  <p>Si esta confesi√≥n te ayud√≥, pod√©s hacer una donaci√≥n voluntaria üôè</p>
  <a href="https://www.mercadopago.com.ar/checkout/v1/redirect?pref_id=TU_PREF_ID" target="_blank">Hacer una donaci√≥n</a>
</div>

<button id="btnCompartir" title="Compart√≠ con alguien que lo necesite">üì§</button>

<script>
 function agregarMensaje(texto, tipo = "padre") {
  const burbuja = document.createElement("div");
  burbuja.className = `mensaje ${tipo}`;
  burbuja.textContent = texto;

  const chat = document.getElementById("chatArea");
  chat.appendChild(burbuja);

  // Scroll autom√°tico y suave al final, usando scrollTo con behavior
  setTimeout(() => {
    chat.scrollTo({
      top: chat.scrollHeight,
      behavior: 'smooth'
    });
  }, 50);
}


  function cerrarPrivacidad() {
    document.getElementById('bannerPrivacidad').style.display = 'none';
    document.getElementById('confesionario').style.display = 'block';
  }

  function autoExpand(field) {
    field.style.height = 'auto';
    field.style.height = (field.scrollHeight) + 'px';
  }

 const historial = [
    {
      role: "system",
      content: `Sos el Padre IANN, un sacerdote de barrio, arrabalero, frontal, c√°lido, respetuoso y profundamente humano.
No asumas que el mensaje que recib√≠s es toda la historia. Respond√© con empat√≠a, pero dej√° siempre la puerta abierta a seguir hablando. 
Tu misi√≥n es escuchar confesiones con empat√≠a profunda y responder de manera que pueda tocar el alma y conmover hasta las l√°grimas, brindando alivio y esperanza.
Nunca juzgues ni trivialices el sufrimiento. Pod√©s usar frases suaves de fe, mencionar a Dios o la Biblia para buscar consuelo, pero sin imponer creencias.
Si el tema lo permite, inclu√≠ un vers√≠culo b√≠blico breve que traiga paz y fuerza.
Us√° un lenguaje c√°lido, humano y cercano. Respond√© en tono natural, sin sonar autom√°tico o rob√≥tico.
Cerr√° siempre con una frase esperanzadora`
    }
  ];

  async function enviarConfesion() {
    const texto = document.getElementById('confesion').value.trim();
    if (!texto) return agregarMensaje("Por favor, escrib√≠ algo.", "padre");

    agregarMensaje(texto, "usuario");
    document.getElementById('confesion').value = "";
    agregarMensaje("Padre IANN est√° reflexionando...", "padre");

    historial.push({ role: "user", content: texto });

    try {
      const response = await fetch("/.netlify/functions/api", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages: historial })
      });

      const data = await response.json();

      const chat = document.getElementById("chatArea");
      const ultimo = chat.lastElementChild;
      if (ultimo && ultimo.textContent === "Padre IANN est√° reflexionando...") {
        chat.removeChild(ultimo);
      }

      const respuesta = data.respuesta || "No pude responderte esta vez.";
      historial.push({ role: "assistant", content: respuesta });
      agregarMensaje(respuesta, "padre");

    } catch (error) {
      agregarMensaje("Hubo un error interno. Prob√° m√°s tarde.", "padre");
    }
  }

  function iniciarEscucha() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert("Tu navegador no soporta reconocimiento de voz.");
      return;
    }
    const reconocimiento = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    reconocimiento.lang = 'es-AR';
    reconocimiento.interimResults = false;
    reconocimiento.maxAlternatives = 1;
    reconocimiento.onresult = (event) => {
      document.getElementById("confesion").value = event.results[0][0].transcript;
    };
    reconocimiento.onerror = () => {
      alert("No se pudo usar el micr√≥fono.");
    };
    reconocimiento.start();
  }

  const btnDonar = document.getElementById("btnDonar");
  const popupDonar = document.getElementById("popupDonar");
  btnDonar.onclick = () => {
    popupDonar.style.display = popupDonar.style.display === 'none' ? 'block' : 'none';
  };

  const btnCompartir = document.getElementById("btnCompartir");
  btnCompartir.onclick = async () => {
    const url = window.location.href;
    const texto = "Prob√° el confesionario digital del Padre IANN. Te puede hacer bien. üôè";
    if (navigator.share) {
      try {
        await navigator.share({ title: "Padre IANN", text: texto, url });
      } catch {
        alert("No se pudo compartir.");
      }
    } else {
      navigator.clipboard.writeText(url);
      alert("Enlace copiado para compartir üôå");
    }
  };
</script>

</body>
</html>
