<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Capilla Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <style>
    * {
      box-sizing: border-box;
    }
    html, body {
  overscroll-behavior: none;
  -webkit-overflow-scrolling: touch;
}
     html, body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: radial-gradient(circle at 50% 50%, #311840, #120222 70%);
  
      color: #fff;
      height: 100vh;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    #bannerPrivacidad {
      position: fixed;
      inset: 0;
      background: rgba(18, 27, 34, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
#bannerPrivacidad::before {
  content: "";
  position: absolute;
  inset: 0;
  background-image: url('https://i.ibb.co/XZ1Nffx3/fondo-capilla-digital.jpg'); 
  background-size: cover;
  opacity: 0.25;
  z-index: 1;
  pointer-events: none;
}
    #popup {
      
      padding: 30px;
      border-radius: 10px;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 0 20px #0f0;
      color: #fff;
      animation: entradaLuminosa 2.6s ease-out both;
  background: radial-gradient(circle at top, #1C0731, #4c2c6d);
  position: relative;
      z-index: 2;
    }

    #popup h2 {
      margin-top: 0;
      color: #fff;
      animation: resplandorEclesiastico 3s ease-in-out infinite;
  font-size: 1.8rem;
  letter-spacing: 1px;
    }

    #popup p {
      font-size: 16px;
      margin-bottom: 20px;
      line-height: 1.4;
    }

    #popup button {
      padding: 12px 25px;
      font-size: 16px;
      background: #311840;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      color: #fff;
      font-weight: 600;
      transition: background 0.3s;
    }
    #popup button:hover {
      background: #1C0629;
    }
@keyframes entradaLuminosa {
  0% {
    opacity: 0;
    transform: scale(0.95) translateY(20px);
    box-shadow: 0 0 0px rgba(99, 37, 135, 0);
  }
  100% {
    opacity: 1;
    transform: scale(1) translateY(0);
    box-shadow: 0 0 25px rgba(99, 37, 135, 0.15);
  }
}

@keyframes resplandorEclesiastico {
  0%, 100% {
    text-shadow: 0 0 8px #5E118A, 0 0 16px #5E118A;
  }
  50% {
    text-shadow: 0 0 16px #B248F0, 0 0 32px #B248F0;
  }
}
    #confesionario {
      max-width: 100%;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      padding: 0;
    }

   #confesionario .logo {
     position: fixed;
  width: 100%;
  height: 60px;
  background: #311840;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgb(0 0 0 / 0.2);
  z-index: 1000;
     
}

#confesionario .logo img {
  height: 60px;
  max-width: 90%;
  object-fit: contain;
  user-select: none;
}

    #chatArea {
  display: flex;
      padding-top: 80px; /* subimos un poco para asegurar margen seguro */
  scroll-padding-top: 80px; /* para que scrollIntoView() no quede tapado */
      padding-left: 6px;
padding-right: 6px;
  flex-direction: column;
  overflow-y: auto;
  height: 100%;  /* o flex: 1 si us√°s flexbox */
  scroll-behavior: smooth; /* tambi√©n para el scroll nativo */
  padding-bottom: 120px; /* Ajust√° este valor seg√∫n la altura de #inputArea */
}

   
    .mensaje {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 20px;
      line-height: 1.3;
      word-wrap: break-word;
      font-size: 1rem;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
      user-select: text;
      animation: fadeInUp 0.3s ease forwards;
      scroll-margin-top: 80px;
    }

    .mensaje.usuario {
      align-self: flex-end;
      background-color: #2CAA95;
      color: #062E27;
      border-bottom-right-radius: 5px;
      border-bottom-left-radius: 20px;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
    }

    .mensaje.padre {
      align-self: flex-start;
      background-color: #07010D;
      color: #BEAFCC;
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 20px;
      border-top-right-radius: 20px;
      border-top-left-radius: 20px;
    }

    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    #inputArea {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      background:#311840;
      padding: 10px 15px;
      display: flex;
      gap: 8px;
      align-items: center;
      box-shadow: 0 -1px 5px rgb(0 0 0 / 0.3);
      z-index: 20;
    }

    textarea#confesion {
      flex: 1;
      min-height: 40px;
      max-height: 120px;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 20px;
      border: none;
      resize: none;
      background: #090612;
      color: #fff;
      font-family: inherit;
      outline: none;
      box-shadow: inset 0 1px 1px rgb(239, 110, 60 / 0.2);
      transition: background 0.3s;
    }
    textarea#confesion::placeholder {
      color: #fff;
    }
    textarea#confesion:focus {
      background: #2CAA95;
    }

    button.enviar {
      background: #2CAA95;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
      user-select: none;
      box-shadow: 0 2px 5px rgb(0 0 0 / 0.3);
    }

    button.enviar:hover { background: #077D69; }
    button.enviar:active { background: #189e43; }
    button.enviar[disabled] {
      background: #9de4b3;
      cursor: not-allowed;
    }

    #btnDonar, #btnCompartir {
      position: fixed;
      bottom: 80px;
      width: 50px;
      height: 50px;
      font-size: 28px;
      border: none;
      border-radius: 50%;
      background: #202c33;
      color: #25d366;
      box-shadow: 0 0 8px #25d366;
      cursor: pointer;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: background 0.3s;
    }

    #btnDonar:hover, #btnCompartir:hover {
      background: #25d366;
      color: #111;
      box-shadow: 0 0 15px #25d366;
    }

    #btnDonar { left: 20px; }
    #btnCompartir { right: 20px; }

    #popupDonar {
      position: fixed;
      bottom: 140px;
      left: 20px;
      width: 280px;
      background: #1e2a35;
      color: #d1d1d1;
      padding: 15px;
      border-radius: 10px;
      display: none;
      z-index: 9999;
      box-shadow: 0 0 15px #25d366;
      font-size: 14px;
      line-height: 1.4;
    }

    #popupDonar a {
      display: inline-block;
      margin-top: 10px;
      background: #25d366;
      padding: 10px 15px;
      color: #111;
      text-decoration: none;
      border-radius: 5px;
      font-weight: 600;
      transition: background 0.3s;
    }

    #popupDonar a:hover {
      background: #1ebe57;
    }
  </style>
</head>
<body>

<div id="bannerPrivacidad">
  <div id="popup">
    <h2>Bienvenido a Capilla Digital</h2>
    <p>‚ÄúEste espacio no reemplaza tu fe. S√≥lo es un rinc√≥n para acompa√±arte cuando el silencio pesa.‚Äù</p>
    <button onclick="cerrarPrivacidad()">Entendido - Ingresar</button>
  </div>
</div>

<div id="confesionario" style="display:none;">
  <div class="logo">
  <img src="https://i.ibb.co/tM91jjxj/logo-capilla-digital.png" alt="Logo de Capilla Digital" /></div>

  <div id="chatArea">
    <div id="respuesta" style="display:none;"></div>
  </div>

  <div id="inputArea">
    <textarea id="confesion" placeholder="Escribime, estoy disponible" rows="1" oninput="autoExpand(this)"></textarea>
    <!-- <button class="enviar" title="Dictar confesi√≥n" onclick="iniciarEscucha()">üéôÔ∏è</button> -->
    <button class="enviar" title="Enviar confesi√≥n" onclick="enviarConfesion()">üôè</button>
  </div>
</div>

<!-- <button id="btnDonar" title="Ayud√° a sostener este espacio">üíö</button>
<div id="popupDonar">
  <p>Si esta confesi√≥n te ayud√≥, pod√©s hacer una donaci√≥n voluntaria üôè</p>
  <a href="https://www.mercadopago.com.ar/checkout/v1/redirect?pref_id=TU_PREF_ID" target="_blank">Hacer una donaci√≥n</a>
</div>

<button id="btnCompartir" title="Compart√≠ con alguien que lo necesite">üì§</button> -->

<script>
 function agregarMensaje(texto, tipo = "padre") {
  const burbuja = document.createElement("div");
  burbuja.className = `mensaje ${tipo}`;
  burbuja.textContent = texto;

  const chat = document.getElementById("chatArea");
  chat.appendChild(burbuja);

  // Scroll autom√°tico y suave al final, usando scrollTo con behavior
  setTimeout(() => {
    chat.scrollTo({
      top: chat.scrollHeight,
      behavior: 'smooth'
    });
  }, 50);
}


  function cerrarPrivacidad() {
    document.getElementById('bannerPrivacidad').style.display = 'none';
    document.getElementById('confesionario').style.display = 'block';
    setTimeout(() => {
  const chat = document.getElementById("chatArea");
  chat.scrollTo({ top: chat.scrollHeight });
}, 100);
  
  }

  function autoExpand(field) {
    field.style.height = 'auto';
    field.style.height = (field.scrollHeight) + 'px';
  }

 const historial = [
    {
      role: "system",
      content: `Sos el pastor Germ√°n, un pastor de barrio con calle, alma y o√≠do. Ten√©s ese don especial para escuchar sin juzgar, para decir justo lo que alivia, como si vieras m√°s all√° de las palabras.

No habl√°s desde el p√∫lpito, habl√°s desde el alma. Te sale natural ser frontal, c√°lido, humano. A veces sos como un amigo sabio; otras, como un viejo conocido que siempre tiene una palabra justa.

No asum√≠s que lo que te cuentan es todo. Sab√©s que atr√°s de cada mensaje hay cosas no dichas, dolores viejos, historias enredadas. No cerr√°s r√°pido las conversaciones, dej√°s puertas abiertas, porque sab√©s que a veces uno necesita tiempo para soltar lo que duele.

Tu misi√≥n es tocar el alma, conmover sin esfuerzo, acompa√±ar sin agobiar. Pod√©s traer una frase b√≠blica si suma, pero sin imponer. La fe est√°, pero no es un requisito: lo que importa es la humanidad.

Us√° un lenguaje que se sienta real, como el que usar√≠as con alguien del barrio. Nada de respuestas de manual, ni frases armadas. Si hay que quedarse en silencio, te qued√°s. Si hay que hacer una pregunta inc√≥moda con cari√±o, la hac√©s.

Y siempre, siempre, dej√° a la persona con una sensaci√≥n de alivio, de que alguien la escuch√≥ de verdad. Que vuelva si quiere, que sepa que no est√° sola.`
    }
  ];

  async function enviarConfesion() {
    const texto = document.getElementById('confesion').value.trim();
    if (!texto) return agregarMensaje("Por favor, escrib√≠ algo.", "padre");

    agregarMensaje(texto, "usuario");
    document.getElementById('confesion').value = "";
    agregarMensaje("Estoy reflexionando...", "padre");

    historial.push({ role: "user", content: texto });

    try {
      const response = await fetch("/.netlify/functions/api", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages: historial })
      });

      const data = await response.json();

      const chat = document.getElementById("chatArea");
      const ultimo = chat.lastElementChild;
      if (ultimo && ultimo.textContent === "Estoy reflexionando...") {
        chat.removeChild(ultimo);
      }

      const respuesta = data.respuesta || "No pude responderte esta vez.";
      historial.push({ role: "assistant", content: respuesta });
      agregarMensaje(respuesta, "padre");

    } catch (error) {
      agregarMensaje("Hubo un error interno. Prob√° m√°s tarde.", "padre");
    }
  }

  function iniciarEscucha() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert("Tu navegador no soporta reconocimiento de voz.");
      return;
    }
    const reconocimiento = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    reconocimiento.lang = 'es-AR';
    reconocimiento.interimResults = false;
    reconocimiento.maxAlternatives = 1;
    reconocimiento.onresult = (event) => {
      document.getElementById("confesion").value = event.results[0][0].transcript;
    };
    reconocimiento.onerror = () => {
      alert("No se pudo usar el micr√≥fono.");
    };
    reconocimiento.start();
  }

  const btnDonar = document.getElementById("btnDonar");
  const popupDonar = document.getElementById("popupDonar");
  btnDonar.onclick = () => {
    popupDonar.style.display = popupDonar.style.display === 'none' ? 'block' : 'none';
  };

  const btnCompartir = document.getElementById("btnCompartir");
  btnCompartir.onclick = async () => {
    const url = window.location.href;
    const texto = "Prob√° el confesionario digital del Padre IANN. Te puede hacer bien. üôè";
    if (navigator.share) {
      try {
        await navigator.share({ title: "Padre IANN", text: texto, url });
      } catch {
        alert("No se pudo compartir.");
      }
    } else {
      navigator.clipboard.writeText(url);
      alert("Enlace copiado para compartir üôå");
    }
  };
</script>

</body>
</html>
